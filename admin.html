<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Stock Approval Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        .request-card {
            transition: all 0.3s ease;
        }
        .request-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.05);
        }
        .tab-button.active {
            border-bottom: 3px solid #4f46e5;
            color: #4f46e5;
        }
        /* Custom scrollbar for table container */
        .table-container {
            max-height: 60vh;
            overflow-y: auto;
        }
        .table-container::-webkit-scrollbar {
            width: 8px;
        }
        .table-container::-webkit-scrollbar-thumb {
            background-color: #ccc;
            border-radius: 4px;
        }
    </style>
</head>
<body>

<div class="main-container">
    <header class="flex justify-between items-center py-4 border-b border-gray-200 mb-6">
        <h1 class="text-3xl font-extrabold text-gray-800">Admin Approval Dashboard</h1>
        <div class="flex items-center space-x-4">
            <button onclick="downloadAllHistoryPDF()" class="flex items-center bg-green-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-600 transition-colors">
                <i data-lucide="download" class="w-5 h-5 mr-2"></i> Download Full History (PDF)
            </button>
            <button onclick="logout()" class="flex items-center bg-red-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-600 transition-colors">
                <i data-lucide="log-out" class="w-5 h-5 mr-2"></i> Logout
            </button>
        </div>
    </header>

    <div id="messageContainer" class="hidden p-4 rounded-lg text-sm mb-6 font-semibold" role="alert"></div>

    <nav class="flex space-x-4 mb-8">
        <button id="pendingTab" class="tab-button py-2 px-4 text-gray-600 font-medium transition-colors active" onclick="selectView('pending')">
            <span class="flex items-center">
                <i data-lucide="clock" class="w-5 h-5 mr-2"></i> Pending Approvals (<span id="pendingCount">0</span>)
            </span>
        </button>
        <button id="historyTab" class="tab-button py-2 px-4 text-gray-600 font-medium transition-colors" onclick="selectView('history')">
            <span class="flex items-center">
                <i data-lucide="history" class="w-5 h-5 mr-2"></i> Approval History
            </span>
        </button>
    </nav>

    <div id="pendingView">
        <div id="pendingRequestsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <p id="noPendingMessage" class="col-span-full text-center text-gray-500 text-lg py-10 hidden">ðŸŽ‰ No pending requests! Time for a coffee break.</p>
        </div>
    </div>

    <div id="historyView" class="hidden">
        <div class="flex space-x-3 mb-4 items-center">
            <h2 class="text-xl font-bold text-gray-700">Filter History By Month:</h2>
            <select id="monthFilter" onchange="renderHistoryView()" class="p-2 border border-gray-300 rounded-lg"></select>
        </div>

        <div class="table-container bg-white rounded-lg shadow-md">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50 sticky top-0">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Request ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item/QTY</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Requested By</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Processed By</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody id="historyTableBody" class="bg-white divide-y divide-gray-200">
                    </tbody>
            </table>
        </div>
        <p id="noHistoryMessage" class="text-center text-gray-500 text-lg py-10 hidden">No approval history found for the selected month.</p>
    </div>

</div>

<script>
    // --- Data Management ---
    let stockRequests = [];
    const ADMIN_USER = "AdminUser"; // Replace with actual logged-in admin username if needed

    // Initial dummy data setup for demonstration
    const initialRequests = [
        { id: 'REQ-001', date: '2025-10-14T09:00:00', item: 'Fibre Optic Cable (10km)', quantity: 1, requestedBy: 'user', status: 'PENDING', processedBy: null },
        { id: 'REQ-002', date: '2025-10-13T15:30:00', item: 'RJ45 Connectors (Box)', quantity: 5, requestedBy: 'user', status: 'APPROVED', processedBy: 'AdminUser' },
        { id: 'REQ-003', date: '2025-10-13T10:15:00', item: 'Ethernet Switch (24-Port)', quantity: 2, requestedBy: 'user', status: 'REJECTED', processedBy: 'AdminUser' },
    ];

    function loadDataFromLocalStorage() {
        const storedRequests = localStorage.getItem('stockRequests');
        if (storedRequests) {
            stockRequests = JSON.parse(storedRequests);
        } else {
            stockRequests = initialRequests;
            saveDataToLocalStorage();
        }
    }

    function saveDataToLocalStorage() {
        localStorage.setItem('stockRequests', JSON.stringify(stockRequests));
    }

    // Utility to display messages
    function showMessage(title, text, type = 'success') {
        const messageContainer = document.getElementById('messageContainer');
        messageContainer.innerHTML = `<strong class="text-lg">${title}:</strong> ${text}`;
        messageContainer.className = `p-4 rounded-lg text-sm mb-6 font-semibold`;
        
        if (type === 'success') {
            messageContainer.classList.add('bg-green-100', 'text-green-800');
        } else if (type === 'error') {
            messageContainer.classList.add('bg-red-100', 'text-red-800');
        } else if (type === 'info') {
            messageContainer.classList.add('bg-blue-100', 'text-blue-800');
        }
        messageContainer.classList.remove('hidden');

        setTimeout(() => {
            messageContainer.classList.add('hidden');
        }, 3000);
    }

    // --- Authentication and Logout ---

    function checkAuth() {
        const role = localStorage.getItem('userRole');
        if (!role || role !== 'admin') {
            alert("Access Denied: Please log in as an Administrator.");
            window.location.href = 'login.html';
        }
    }

    function logout() {
        localStorage.removeItem('userRole');
        alert("You have been logged out.");
        window.location.href = 'login.html';
    }

    // --- Main Logic: Processing Requests ---

    function processRequest(request, action) {
        let success = false;
        let message = '';
        const now = new Date().toISOString();
        
        const requestIndex = stockRequests.findIndex(r => r.id === request.id);

        if (requestIndex !== -1) {
            const currentRequest = stockRequests[requestIndex];

            if (action === 'approve') {
                currentRequest.status = 'APPROVED';
                currentRequest.processedBy = ADMIN_USER;
                currentRequest.processedDate = now;
                message = `Request ${request.id} has been APPROVED.`;
                success = true;
            } else if (action === 'reject') {
                currentRequest.status = 'REJECTED';
                currentRequest.processedBy = ADMIN_USER;
                currentRequest.processedDate = now;
                message = `Request ${request.id} has been REJECTED.`;
                success = true;
            } else if (action === 're-approve' && currentRequest.status === 'REJECTED') {
                currentRequest.status = 'APPROVED'; // Revert to Approved
                currentRequest.processedBy = ADMIN_USER;
                currentRequest.processedDate = now;
                message = `Request ${request.id} has been RE-APPROVED.`;
                success = true;
            } else {
                showMessage('Error', 'Invalid action or request status.', 'error');
                return;
            }

            if (success) {
                stockRequests[requestIndex] = currentRequest;
                saveDataToLocalStorage();
                showMessage('Success', message);
                // Re-render the current view
                selectView(document.getElementById('pendingView').classList.contains('hidden') ? 'history' : 'pending');
            }
        } else {
            showMessage('Error', `Request ID ${request.id} not found.`, 'error');
        }
    }

    // --- Rendering and View Management ---
    
    let currentView = 'pending';

    function selectView(view) {
        if (currentView === view) return;

        const pendingView = document.getElementById('pendingView');
        const historyView = document.getElementById('historyView');
        const pendingTab = document.getElementById('pendingTab');
        const historyTab = document.getElementById('historyTab');

        if (view === 'pending') {
            pendingView.classList.remove('hidden');
            historyView.classList.add('hidden');
            pendingTab.classList.add('active');
            historyTab.classList.remove('active');
            renderPendingView();
        } else {
            pendingView.classList.add('hidden');
            historyView.classList.remove('hidden');
            pendingTab.classList.remove('active');
            historyTab.classList.add('active');
            renderMonthlyFolders(); // Pre-populates the month filter
            renderHistoryView();
        }
        currentView = view;
    }

    // Utility function for formatting date
    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', {
            year: 'numeric', month: 'short', day: 'numeric',
            hour: '2-digit', minute: '2-digit'
        });
    }

    function getStatusBadge(status) {
        const base = 'px-3 py-1 text-xs font-semibold rounded-full';
        switch (status) {
            case 'PENDING': return `${base} bg-yellow-100 text-yellow-800`;
            case 'APPROVED': return `${base} bg-green-100 text-green-800`;
            case 'REJECTED': return `${base} bg-red-100 text-red-800`;
            default: return base;
        }
    }

    function renderPendingView() {
        const container = document.getElementById('pendingRequestsContainer');
        const pendingRequests = stockRequests.filter(req => req.status === 'PENDING');
        
        document.getElementById('pendingCount').textContent = pendingRequests.length;
        document.getElementById('noPendingMessage').classList.toggle('hidden', pendingRequests.length > 0);
        container.innerHTML = ''; // Clear existing cards

        pendingRequests.forEach(request => {
            const card = document.createElement('div');
            card.className = 'request-card bg-white p-6 rounded-xl shadow-lg border border-gray-100 flex flex-col justify-between';
            
            const requestData = JSON.stringify(request).replace(/"/g, '&quot;');

            card.innerHTML = `
                <div>
                    <div class="flex justify-between items-start mb-4">
                        <span class="${getStatusBadge(request.status)}">${request.status}</span>
                        <span class="text-sm font-medium text-gray-500">${formatDate(request.date)}</span>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-1">${request.item}</h3>
                    <p class="text-2xl font-extrabold text-indigo-600 mb-4">QTY: ${request.quantity}</p>
                    <div class="text-sm text-gray-600 space-y-1">
                        <p><span class="font-medium">Request ID:</span> ${request.id}</p>
                        <p><span class="font-medium">Requested By:</span> ${request.requestedBy}</p>
                    </div>
                </div>
                <div class="mt-6 flex space-x-3">
                    <button class="flex-1 approve-btn bg-green-600 text-white p-3 rounded-lg font-semibold hover:bg-green-700 transition-colors" data-action="approve" data-request="${requestData}">
                        <i data-lucide="check" class="w-5 h-5 inline mr-1"></i> Approve
                    </button>
                    <button class="flex-1 reject-btn bg-red-600 text-white p-3 rounded-lg font-semibold hover:bg-red-700 transition-colors" data-action="reject" data-request="${requestData}">
                        <i data-lucide="x" class="w-5 h-5 inline mr-1"></i> Reject
                    </button>
                </div>
            `;
            container.appendChild(card);
        });

        lucide.createIcons(); // Re-render Lucide icons for new elements
    }

    function renderHistoryRow(request) {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50';

        const statusBadge = `<span class="${getStatusBadge(request.status)}">${request.status}</span>`;
        
        let actionButton = '';
        if (request.status === 'REJECTED') {
            const requestData = JSON.stringify(request).replace(/"/g, '&quot;');
            actionButton = `
                <button class="re-approve-btn bg-blue-500 text-white px-3 py-1 rounded text-xs font-semibold hover:bg-blue-600 transition-colors" 
                        data-request="${requestData}">
                    Re-Approve
                </button>
            `;
        }

        row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatDate(request.processedDate || request.date)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${request.id}</td>
            <td class="px-6 py-4 whitespace-wrap text-sm text-gray-900">${request.item} / QTY: ${request.quantity}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${request.requestedBy}</td>
            <td class="px-6 py-4 whitespace-nowrap">${statusBadge}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${request.processedBy || 'N/A'}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${actionButton}</td>
        `;
        return row;
    }

    function renderMonthlyFolders() {
        const filterSelect = document.getElementById('monthFilter');
        filterSelect.innerHTML = '<option value="all">All History</option>';

        // Get unique month/year strings
        const monthYears = stockRequests
            .filter(r => r.processedDate || r.status !== 'PENDING') // Only show processed or original date for non-pending
            .map(r => {
                const date = new Date(r.processedDate || r.date);
                return date.getFullYear() + '-' + (date.getMonth() + 1).toString().padStart(2, '0');
            })
            .filter((value, index, self) => self.indexOf(value) === index) // Unique values
            .sort((a, b) => new Date(b) - new Date(a)); // Sort descending

        monthYears.forEach(my => {
            const date = new Date(my);
            const label = date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
            const option = document.createElement('option');
            option.value = my;
            option.textContent = label;
            filterSelect.appendChild(option);
        });
    }

    function renderHistoryView() {
        const tbody = document.getElementById('historyTableBody');
        const filterMonth = document.getElementById('monthFilter').value;
        tbody.innerHTML = ''; // Clear existing rows

        let filteredRequests = stockRequests
            // Filter out PENDING for history view
            .filter(req => req.status !== 'PENDING')
            // Sort by processing date descending
            .sort((a, b) => new Date(b.processedDate || b.date) - new Date(a.processedDate || a.date));

        if (filterMonth !== 'all') {
             filteredRequests = filteredRequests.filter(req => {
                const dateString = req.processedDate || req.date;
                const date = new Date(dateString);
                const monthYear = date.getFullYear() + '-' + (date.getMonth() + 1).toString().padStart(2, '0');
                return monthYear === filterMonth;
            });
        }

        document.getElementById('noHistoryMessage').classList.toggle('hidden', filteredRequests.length > 0);

        filteredRequests.forEach(request => {
            tbody.appendChild(renderHistoryRow(request));
        });
    }

    // --- PDF Generation ---
    function downloadAllHistoryPDF() {
        // window.jsPDF is available via the jspdf.umd.min.js script
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        doc.setFontSize(18);
        doc.text("Stock Approval History Report", 14, 22);
        doc.setFontSize(10);
        doc.text(`Generated: ${formatDate(new Date().toISOString())}`, 14, 28);
        doc.setFontSize(12);
        
        const historyData = stockRequests
            .filter(req => req.status !== 'PENDING')
            .sort((a, b) => new Date(b.processedDate || b.date) - new Date(a.processedDate || a.date));

        if (historyData.length === 0) {
            alert("No history data to export.");
            return;
        }

        const columns = [
            { header: 'ID', dataKey: 'id' },
            { header: 'Date', dataKey: 'date' },
            { header: 'Item', dataKey: 'item' },
            { header: 'QTY', dataKey: 'quantity' },
            { header: 'By', dataKey: 'requestedBy' },
            { header: 'Status', dataKey: 'status' },
            { header: 'Processed By', dataKey: 'processedBy' },
        ];
        
        const rows = historyData.map(req => ({
            id: req.id,
            date: formatDate(req.processedDate || req.date),
            item: req.item,
            quantity: req.quantity,
            requestedBy: req.requestedBy,
            status: req.status,
            processedBy: req.processedBy || 'N/A',
        }));

        doc.autoTable({
            startY: 35,
            head: [columns.map(c => c.header)],
            body: rows.map(r => columns.map(c => r[c.dataKey])),
            theme: 'striped',
            styles: { fontSize: 8, cellPadding: 2, overflow: 'linebreak' },
            headStyles: { fillColor: [79, 70, 229] }, // Indigo-600
        });

        doc.save("Stock_Approval_History.pdf");
        showMessage('Export', 'History successfully exported to PDF.', 'info');
    }

    // --- Event Listeners and Initialization ---

    document.addEventListener('click', (e) => {
        const target = e.target;
        let action = null;
        let requestString = null;
        
        // Find the closest button that has the data-action attribute
        if (target.closest('.approve-btn, .reject-btn')) {
            const btn = target.closest('.approve-btn, .reject-btn');
            action = btn.getAttribute('data-action');
            requestString = btn.getAttribute('data-request');
        }

        if (action && requestString) {
            try {
                const request = JSON.parse(requestString);
                processRequest(request, action);
            } catch (error) {
                 console.error("Failed to parse request data:", error);
                 showMessage('Data Error', 'Could not process request data.', 'error');
            }
        } 
        else if (target.closest('.re-approve-btn')) {
            const btn = target.closest('.re-approve-btn');
            const reqString = btn.getAttribute('data-request');
            
            if (reqString) {
                try {
                    const request = JSON.parse(reqString);
                    if (request.status === 'REJECTED') {
                        processRequest(request, 're-approve');
                    } else {
                        showMessage('Invalid Action', `This request has status: ${request.status}. Only REJECTED items can be re-approved.`, 'error');
                    }
                } catch (error) {
                    console.error("Failed to parse request data:", error);
                    showMessage('Data Error', 'Could not process request data.', 'error');
                }
            }
        }
    });

    // --- Initialization ---\
    document.addEventListener('DOMContentLoaded', () => {
         checkAuth(); // Check if the admin is logged in
         lucide.createIcons();
         loadDataFromLocalStorage();
         selectView('pending'); // Start on the pending view
    });
</script>
</body>
</html>
